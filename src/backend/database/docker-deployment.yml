# =============================================
# AnuLunar Spiritual Intelligence‚Ñ¢
# Docker Deployment Configuration
# =============================================

version: '3.8'

services:
  # Main API Service
  anulunar-api:
    build:
      context: .
      dockerfile: Dockerfile.api
    environment:
      - NODE_ENV=production
      - PORT=3000
    env_file:
      - .env.production
    ports:
      - "3000:3000"
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - ./logs:/app/logs
    networks:
      - anulunar-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Swiss Ephemeris Background Processor
  anulunar-ephemeris-processor:
    build:
      context: .
      dockerfile: Dockerfile.processor
    environment:
      - NODE_ENV=production
    env_file:
      - .env.production
    restart: unless-stopped
    depends_on:
      - redis
    volumes:
      - ./logs:/app/logs
    networks:
      - anulunar-network
    deploy:
      replicas: 2  # Run 2 instances for reliability

  # Redis Cache (optional but recommended)
  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data
    restart: unless-stopped
    networks:
      - anulunar-network
    command: redis-server --appendonly yes

  # Nginx Load Balancer
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
      - ./ssl:/etc/nginx/ssl
    depends_on:
      - anulunar-api
    restart: unless-stopped
    networks:
      - anulunar-network

volumes:
  redis-data:
    driver: local

networks:
  anulunar-network:
    driver: bridge

---

# =============================================
# Dockerfile.api
# =============================================
FROM node:18-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy application code
COPY . .

# Create logs directory
RUN mkdir -p logs

# Expose port
EXPOSE 3000

# Health check
HEALTHCHECK --interval=30s --timeout=3s --start-period=5s --retries=3 \
  CMD curl -f http://localhost:3000/health || exit 1

# Start API server
CMD ["node", "src/server.js"]

---

# =============================================
# Dockerfile.processor
# =============================================
FROM node:18-alpine

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy application code
COPY . .

# Create logs directory
RUN mkdir -p logs

# Start Swiss Ephemeris processor
CMD ["node", "src/swiss_ephemeris_processor.js"]

---

# =============================================
# nginx.conf
# =============================================
events {
    worker_connections 1024;
}

http {
    upstream anulunar_api {
        server anulunar-api:3000;
    }

    # Rate limiting
    limit_req_zone $binary_remote_addr zone=api:10m rate=10r/s;

    server {
        listen 80;
        server_name api.anulunar.com;

        # Redirect HTTP to HTTPS
        return 301 https://$server_name$request_uri;
    }

    server {
        listen 443 ssl http2;
        server_name api.anulunar.com;

        # SSL Configuration
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers ECDHE-RSA-AES256-GCM-SHA512:DHE-RSA-AES256-GCM-SHA512:ECDHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-SHA384;
        ssl_prefer_server_ciphers off;

        # Security headers
        add_header X-Frame-Options DENY;
        add_header X-Content-Type-Options nosniff;
        add_header X-XSS-Protection "1; mode=block";
        add_header Strict-Transport-Security "max-age=63072000; includeSubDomains; preload";

        # API routes
        location /v1/ {
            limit_req zone=api burst=20 nodelay;
            
            proxy_pass http://anulunar_api;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Timeouts
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
        }

        # Health check endpoint
        location /health {
            proxy_pass http://anulunar_api/health;
            access_log off;
        }

        # Block sensitive paths
        location ~ /\. {
            deny all;
            access_log off;
            log_not_found off;
        }
    }
}

---

# =============================================
# Kubernetes Deployment (Alternative)
# =============================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: anulunar-api
  labels:
    app: anulunar-api
spec:
  replicas: 3
  selector:
    matchLabels:
      app: anulunar-api
  template:
    metadata:
      labels:
        app: anulunar-api
    spec:
      containers:
      - name: api
        image: anulunar/api:latest
        ports:
        - containerPort: 3000
        env:
        - name: NODE_ENV
          value: "production"
        - name: SUPABASE_URL
          valueFrom:
            secretKeyRef:
              name: anulunar-secrets
              key: supabase-url
        - name: SUPABASE_SERVICE_KEY
          valueFrom:
            secretKeyRef:
              name: anulunar-secrets
              key: supabase-service-key
        resources:
          requests:
            memory: "256Mi"
            cpu: "250m"
          limits:
            memory: "512Mi"
            cpu: "500m"
        livenessProbe:
          httpGet:
            path: /health
            port: 3000
          initialDelaySeconds: 30
          periodSeconds: 10

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: anulunar-processor
  labels:
    app: anulunar-processor
spec:
  replicas: 2
  selector:
    matchLabels:
      app: anulunar-processor
  template:
    metadata:
      labels:
        app: anulunar-processor
    spec:
      containers:
      - name: processor
        image: anulunar/processor:latest
        env:
        - name: NODE_ENV
          value: "production"
        - name: SUPABASE_URL
          valueFrom:
            secretKeyRef:
              name: anulunar-secrets
              key: supabase-url
        - name: SUPABASE_SERVICE_KEY
          valueFrom:
            secretKeyRef:
              name: anulunar-secrets
              key: supabase-service-key
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

---

# =============================================
# Production Deployment Script
# =============================================
#!/bin/bash

# deploy.sh - AnuLunar Production Deployment

set -e

echo "üåü Deploying AnuLunar Spiritual Intelligence‚Ñ¢ Backend..."

# Build and push Docker images
echo "üì¶ Building Docker images..."
docker build -f Dockerfile.api -t anulunar/api:latest .
docker build -f Dockerfile.processor -t anulunar/processor:latest .

# Push to registry (adjust for your registry)
echo "üöÄ Pushing to registry..."
docker push anulunar/api:latest
docker push anulunar/processor:latest

# Deploy with Docker Compose
echo "üåô Starting services..."
docker-compose -f docker-compose.prod.yml up -d

# Wait for services to be healthy
echo "‚è≥ Waiting for services to start..."
sleep 30

# Run database migrations if needed
echo "üóÉÔ∏è Running database migrations..."
docker-compose -f docker-compose.prod.yml exec anulunar-api npm run migrate

# Verify deployment
echo "üîç Verifying deployment..."
curl -f http://localhost:3000/health || exit 1

echo "‚úÖ AnuLunar backend deployment complete!"
echo "üåå API available at: https://api.anulunar.com"
echo "üìä Monitor logs with: docker-compose -f docker-compose.prod.yml logs -f"